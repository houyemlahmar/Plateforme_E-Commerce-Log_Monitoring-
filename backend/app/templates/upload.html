{% extends "base.html" %}

{% block title %}Upload Logs - E-commerce Platform{% endblock %}

{% block extra_css %}
<style>
    .drag-active {
        border-color: #667eea !important;
        background-color: #f0f4ff !important;
    }
    .file-upload-area {
        transition: all 0.3s ease;
    }
    .file-upload-area:hover {
        border-color: #667eea;
        background-color: #fafbff;
    }
    .progress-bar-fill {
        transition: width 0.3s ease;
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .status-success { background-color: #d1fae5; color: #065f46; }
    .status-error { background-color: #fee2e2; color: #991b1b; }
    .status-processing { background-color: #dbeafe; color: #1e40af; }
    .status-pending { background-color: #fef3c7; color: #92400e; }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Upload Section (2/3) -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-lg p-6">
                
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-file-upload text-purple-600 mr-2"></i>
                    Upload New File
                </h2>
                
                <!-- File Type Selector -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">File Type</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="fileType" value="json" checked class="mr-2 text-purple-600 focus:ring-purple-500">
                            <span class="text-gray-700 font-medium">
                                <i class="fas fa-file-code text-blue-600 mr-1"></i>
                                JSON
                            </span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="fileType" value="csv" class="mr-2 text-purple-600 focus:ring-purple-500">
                            <span class="text-gray-700 font-medium">
                                <i class="fas fa-file-csv text-green-600 mr-1"></i>
                                CSV
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- Drag & Drop Area -->
                <div id="dropArea" class="file-upload-area border-3 border-dashed border-gray-300 rounded-xl p-8 text-center mb-6 cursor-pointer">
                    <div id="uploadPrompt">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                        <p class="text-lg font-semibold text-gray-700 mb-2">Drag & Drop your file here</p>
                        <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                        <button type="button" onclick="event.stopPropagation(); document.getElementById('fileInput').click();" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-semibold transition duration-200">
                            Select File
                        </button>
                        <input type="file" id="fileInput" class="hidden" accept=".json,.csv">
                        <p class="text-xs text-gray-400 mt-4">
                            <i class="fas fa-info-circle mr-1"></i>
                            Max size: 100 MB | Formats: JSON, CSV
                        </p>
                    </div>
                    
                    <div id="selectedFile" class="hidden">
                        <i class="fas fa-file-alt text-5xl text-purple-600 mb-3"></i>
                        <p class="text-lg font-semibold text-gray-800 mb-2" id="fileName"></p>
                        <p class="text-sm text-gray-500 mb-4" id="fileSize"></p>
                        <button type="button" onclick="clearFile()" class="text-red-600 hover:text-red-700 font-semibold">
                            <i class="fas fa-times mr-1"></i>
                            Remove
                        </button>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="hidden mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-gray-700">Uploading...</span>
                        <span class="text-sm font-semibold text-purple-600" id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="progressBar" class="progress-bar-fill bg-gradient-to-r from-purple-600 to-blue-600 h-full rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Messages -->
                <div id="messageArea"></div>
                
                <!-- Upload Button -->
                <button id="uploadBtn" onclick="uploadFile()" disabled class="w-full bg-gray-400 text-white py-3 rounded-lg font-bold text-lg transition duration-200 cursor-not-allowed">
                    <i class="fas fa-upload mr-2"></i>
                    Upload File
                </button>
                
            </div>
        </div>
        
        <!-- Recent Uploads Section (1/3) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-lg p-6">
                
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-history text-purple-600 mr-2"></i>
                        Recent Uploads
                    </h2>
                    <button onclick="refreshUploads()" class="text-purple-600 hover:text-purple-700">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div id="recentUploads" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Recent uploads will be loaded here -->
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p class="text-sm">No uploads yet</p>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
    
    <!-- Info Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center space-x-3">
                <i class="fas fa-info-circle text-blue-600 text-2xl"></i>
                <div>
                    <h3 class="font-bold text-gray-800">JSON Format</h3>
                    <p class="text-sm text-gray-600">Array of log objects with fields: timestamp, level, service, message, etc.</p>
                </div>
            </div>
        </div>
        
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center space-x-3">
                <i class="fas fa-table text-green-600 text-2xl"></i>
                <div>
                    <h3 class="font-bold text-gray-800">CSV Format</h3>
                    <p class="text-sm text-gray-600">Header row required. Columns: timestamp, level, service, message, etc.</p>
                </div>
            </div>
        </div>
        
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <div class="flex items-center space-x-3">
                <i class="fas fa-bolt text-purple-600 text-2xl"></i>
                <div>
                    <h3 class="font-bold text-gray-800">Processing</h3>
                    <p class="text-sm text-gray-600">Files are validated, parsed, and indexed automatically in Elasticsearch.</p>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
    const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100 MB
    const ALLOWED_EXTENSIONS = {
        'json': ['.json'],
        'csv': ['.csv']
    };
    
    let selectedFile = null;
    let selectedFileType = 'json';
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        setupDragAndDrop();
        setupFileInput();
        setupFileTypeSelector();
        loadRecentUploads();
    });
    
    // Drag and Drop Setup
    function setupDragAndDrop() {
        const dropArea = document.getElementById('dropArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.classList.add('drag-active');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.classList.remove('drag-active');
            }, false);
        });
        
        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => {
            if (!selectedFile) {
                document.getElementById('fileInput').click();
            }
        });
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }
    
    // File Input Setup
    function setupFileInput() {
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
    }
    
    // File Type Selector
    function setupFileTypeSelector() {
        document.querySelectorAll('input[name="fileType"]').forEach(radio => {
            radio.addEventListener('change', function(e) {
                selectedFileType = e.target.value;
                if (selectedFile) {
                    validateFile(selectedFile);
                }
            });
        });
    }
    
    // Handle File
    function handleFile(file) {
        if (validateFile(file)) {
            selectedFile = file;
            displaySelectedFile(file);
            enableUploadButton();
        }
    }
    
    // Validate File
    function validateFile(file) {
        clearMessages();
        
        // Check file size
        if (file.size > MAX_FILE_SIZE) {
            showError(`File size exceeds 100 MB limit. Your file: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            return false;
        }
        
        // Check file extension
        const fileName = file.name.toLowerCase();
        const allowedExts = ALLOWED_EXTENSIONS[selectedFileType];
        const isValidExtension = allowedExts.some(ext => fileName.endsWith(ext));
        
        if (!isValidExtension) {
            showError(`Invalid file type. Please select a ${selectedFileType.toUpperCase()} file.`);
            return false;
        }
        
        return true;
    }
    
    // Display Selected File
    function displaySelectedFile(file) {
        document.getElementById('uploadPrompt').classList.add('hidden');
        document.getElementById('selectedFile').classList.remove('hidden');
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
    }
    
    // Clear File
    function clearFile() {
        selectedFile = null;
        document.getElementById('uploadPrompt').classList.remove('hidden');
        document.getElementById('selectedFile').classList.add('hidden');
        document.getElementById('fileInput').value = '';
        disableUploadButton();
        clearMessages();
    }
    
    // Enable/Disable Upload Button
    function enableUploadButton() {
        const btn = document.getElementById('uploadBtn');
        btn.disabled = false;
        btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
        btn.classList.add('bg-purple-600', 'hover:bg-purple-700', 'cursor-pointer');
    }
    
    function disableUploadButton() {
        const btn = document.getElementById('uploadBtn');
        btn.disabled = true;
        btn.classList.add('bg-gray-400', 'cursor-not-allowed');
        btn.classList.remove('bg-purple-600', 'hover:bg-purple-700', 'cursor-pointer');
    }
    
    // Upload File
    async function uploadFile() {
        if (!selectedFile) return;
        
        clearMessages();
        disableUploadButton();
        showProgress();
        
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        try {
            const response = await fetch('/api/logs/upload', {
                method: 'POST',
                body: formData
            });
            
            updateProgress(100);
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                const jobId = data.data?.job_id || data.job_id || 'N/A';
                showSuccess(`File uploaded successfully! Job ID: ${jobId}`);
                clearFile();
                loadRecentUploads();
            } else {
                showError(data.error || data.message || 'Upload failed. Please try again.');
            }
            
        } catch (error) {
            console.error('Upload error:', error);
            showError('Network error. Please check your connection and try again.');
        } finally {
            setTimeout(() => {
                hideProgress();
                enableUploadButton();
            }, 1000);
        }
    }
    
    // Progress Bar
    function showProgress() {
        document.getElementById('uploadProgress').classList.remove('hidden');
        updateProgress(0);
        // Simulate progress
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            if (progress <= 90) {
                updateProgress(progress);
            } else {
                clearInterval(interval);
            }
        }, 200);
    }
    
    function updateProgress(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressPercent').textContent = percent + '%';
    }
    
    function hideProgress() {
        document.getElementById('uploadProgress').classList.add('hidden');
    }
    
    // Messages
    function showSuccess(message) {
        const html = `
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-600 text-xl mr-3"></i>
                    <p class="text-green-800 font-medium">${message}</p>
                </div>
            </div>
        `;
        document.getElementById('messageArea').innerHTML = html;
    }
    
    function showError(message) {
        const html = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-600 text-xl mr-3"></i>
                    <p class="text-red-800 font-medium">${message}</p>
                </div>
            </div>
        `;
        document.getElementById('messageArea').innerHTML = html;
    }
    
    function clearMessages() {
        document.getElementById('messageArea').innerHTML = '';
    }
    
    // Load Recent Uploads
    async function loadRecentUploads() {
        try {
            const response = await fetch('/api/logs/uploads/recent?limit=10');
            const data = await response.json();
            
            if (data.success && data.uploads && data.uploads.length > 0) {
                displayRecentUploads(data.uploads);
            } else {
                displayNoUploads();
            }
        } catch (error) {
            console.error('Error loading recent uploads:', error);
            displayNoUploads();
        }
    }
    
    function displayRecentUploads(uploads) {
        const html = uploads.map(upload => {
            const statusClass = getStatusClass(upload.status);
            const statusIcon = getStatusIcon(upload.status);
            const date = new Date(upload.uploaded_at).toLocaleString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            return `
                <div class="border border-gray-200 rounded-lg p-3 hover:shadow-md transition duration-200">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 text-sm truncate" title="${upload.filename}">
                                <i class="fas fa-file-alt text-gray-400 mr-1"></i>
                                ${upload.filename}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="far fa-clock mr-1"></i>
                                ${date}
                            </p>
                        </div>
                    </div>
                    <span class="status-badge ${statusClass}">
                        <i class="${statusIcon} mr-1"></i>
                        ${upload.status}
                    </span>
                </div>
            `;
        }).join('');
        
        document.getElementById('recentUploads').innerHTML = html;
    }
    
    function displayNoUploads() {
        document.getElementById('recentUploads').innerHTML = `
            <div class="text-center text-gray-400 py-8">
                <i class="fas fa-inbox text-4xl mb-2"></i>
                <p class="text-sm">No uploads yet</p>
            </div>
        `;
    }
    
    function getStatusClass(status) {
        const statusMap = {
            'completed': 'status-success',
            'success': 'status-success',
            'processing': 'status-processing',
            'pending': 'status-pending',
            'queued': 'status-pending',
            'error': 'status-error',
            'failed': 'status-error'
        };
        return statusMap[status.toLowerCase()] || 'status-pending';
    }
    
    function getStatusIcon(status) {
        const iconMap = {
            'completed': 'fas fa-check-circle',
            'success': 'fas fa-check-circle',
            'processing': 'fas fa-spinner fa-spin',
            'pending': 'fas fa-clock',
            'queued': 'fas fa-clock',
            'error': 'fas fa-exclamation-circle',
            'failed': 'fas fa-exclamation-circle'
        };
        return iconMap[status.toLowerCase()] || 'fas fa-clock';
    }
    
    function refreshUploads() {
        loadRecentUploads();
    }
</script>
{% endblock %}
